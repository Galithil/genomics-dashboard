<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Genomics Production Dashboard</title>
		<script type="text/javascript" src="d3/d3.v3.js"></script>
        <script type="text/javascript" src="d3/box.js"></script>
	    <script type="text/javascript" src="d3/colorbrewer.js"></script>
		<script type="text/javascript" src="dashboard.js"></script>
		<script type="text/javascript" src="dashboard_problems.js"></script>
		<script type="text/javascript" src="stack.js"></script>
        <link rel="stylesheet" type="text/css" href="dashboard.css">
	</head>
	<body>

		<div id="header">
            <div id="header_title">
                <h1 id="title">Genomics Process status</h1>
                <span id="date"></span> - <em>Data for the previous 12 weeks</em>
            </div>
            <div id=starts style="display: none">
                Sequencing lanes started/week (HiSeq/MiSeq): <span id="lane_starts"></span><br>
                Lib prep samples started/week (DNA/RNA/SeqCap/Other): <span id="prep_starts"></span>
            </div>
        </div>
        <br class="clear">
        <div id="status_panels">
            <!--Old ongoing panel - change to only show rec ctrl-->
			<div id="ongoing_bc">
                <h2>Rec Ctrl - All</h2>
				<div id="ongoing_bc_plot">
					<h3># projects</h3>
				</div>
            </div>
            
			<!--Queue panels -->
			<div id="queue">
				<h2>Queue - Production (Queue date, but not started)</h2>
				<div id="load_charts">
					<div id="queue_lp_load"> <!--was queue_sample_load - rename-->
						<h3>Lib prep</h3>
						
                        <div id="queue_sample_load_lp"> <!--NEW-->
                            <h4>Samples</h4>
                        </div>
						<div id="queue_lane_load_lp">
							<h4>Lanes</h4>
						</div>
					</div>
					<div id="queue_fl_load"> <!--was queue_lane_load-->
						<h3>Finished lib</h3>
						<div id="queue_lane_load_fl">
							<h4>Lanes</h4>            
						</div>
					</div>
				</div>
			</div>
            <!--Ongoing panels -> change to load-->
            <div id="ongoing">
                <h2>Ongoing - Production (started, but not delivered)</h2>
                <div id="ongoing_load_charts">
                    <div id="libprep_load">
                        <h3>Lib prep</h3>
                        <div id="libprep_sample_load">
                            <h4>Sample load</h4>
                        </div>
                        <div id="libprep_lane_load">
                            <h4>Lane load</h4>
                        </div>
                    </div>
                    <div id="seq_load">
                        <h3>Sequencing</h3>                       
                        <div id="seq_load_stack">
                            <h4>Lane load</h4>
                        </div>
                    </div>
                </div>
            </div>
            <br class="clear">
            <!--Delivery time run charts-->
            <div id="total_del_times" class="times_panel">
                <h2>Total delivery times - <span id="total_legend">All projects</span></h2>
                <h3>Production (Queue date - All samples sequenced)</h3>
                <div id="total_rc">
                    <h3>Run chart</h3>
                    <!--<h3 id="total_rc_legend">All projects</h3>-->
                </div>
                <div id="total_bp" class="boxplot_panel">
                    <h3>Variability</h3>
                    <!--<h3 id="total_bp_legend">All projects</h3>-->
                </div>
            </div>
            <div id="rec_ctrl_del_times" class="times_panel">
                <h2 id="rec_ctrl_legend">Rec control delivery times - All projects</h2>
                <h3>Production (Open date - Queue date)</h3>
                <div id="rec_ctrl_rc">
                    <h3>Run chart</h3>
                    <!--<h3 id="rec_ctrl_rc_legend">All projects</h3>-->
                </div>
                <div id="rec_ctrl_bp" class="boxplot_panel">
                    <h3>Variability</h3>
                    <!--<h3 id="rec_ctrl_bp_legend">All projects</h3>-->
                </div>
            </div>
            <div id="lib_prep_del_times" class="times_panel">
                <h2 id="lib_prep_legend">Lib prep delivery times - Lib prep projects</h2>
                <h3>Production (Queue date - Library QC)</h3>
                <div id="lib_prep_rc">
                    <h3>Run chart</h3>
                    <!--<h3 id="lib_prep_rc_legend">All projects</h3>-->
                </div>
                <div id="lib_prep_bp" class="boxplot_panel">
                    <h3>Variability</h3>
                    <!--<h3 id="lib_prep_bp_legend">All projects</h3>-->
                </div>
            </div>
            <div id="seq_del_times" class="times_panel">
                <h2>Sequencing delivery times - <span id="seq_legend">All projects</span></h2>
                <h3>Production (Library QC - All samples sequenced)</h3>
                <div id="seq_rc">
                    <h3>Run chart</h3>
                    <!--<h3 id="seq_rc_legend">All projects</h3>-->
                </div>
                <div id="seq_bp" class="boxplot_panel">
                    <h3>Variability</h3>
                    <!--<h3 id="seq_bp_legend">All projects</h3>-->
                </div>
            </div>
            <br class="clear">
        </div>
        <!--"Problem panels"-->
        <div id="problem_panels"  style="display: none">
            <div id="fs_prog_bc" class="barchart_panel">
                <h2>Rec control</h2>
                <p>samples progressed failed in rec ctrl</p>
            </div>
    
            <div id="failed_samples_per_workset"  class="times_panel">
                <h2>Lib prep - #failed samples/workset</h2>
                <div id="fs_ws_rc">
                    <h3>Run chart</h3>
                </div>
                <div id="fs_ws_bp" class="boxplot_panel">
                    <h3>Variability</h3>
                    <!--<h3 id="seq_bp_legend">All projects</h3>-->
                </div>
            </div>
            <div id="data_delivered"  class="times_panel">
                <h2>Seq - data delivered / data ordered</h2>
                <div id="data_del_rc">
                    <h3>Run chart</h3>
                </div>
                <div id="data_del_bp" class="boxplot_panel">
                    <h3>Variability</h3>
                </div>
            </div>
        </div>
		<script type="text/javascript">
            // check every hour if time is between 7 and 8
            // if so, reload window
            var oneHour = 1000*60*60;
            window.setTimeout(function() {
                        window.location.reload();
                },
                //20000
                oneHour
            );

            var today = new Date(); // today
			var twelveWeeks = new Date( today.getTime() - 12 * 7 * 1000*60*60*24);
			var winWidth = window.innerWidth;
            var winHeight = window.innerHeight;
            console.log("w: " + winWidth + ", h: " + winHeight);
			
			//var panelHeights = (winHeight - 305) / 2;
			var panelHeights = (winHeight - 200) / 2;
						
			//var rcWidth = (winWidth - 440) / 3;
			var rcWidth = (winWidth - 460) / 4;
			var drawWidth = (winWidth - 500);
            
            /** 
            * Database source
            */ 
            var dbSource = "" // local, dev or "" (=tools)
			var applDataUrl ="getCouchDbData.php?db=projects&design=process_flow&view=KPI_applications&group_level=3&" + dbSource;
			
            console.log(applDataUrl);	
            var dateStr = today.getFullYear() + "-" + today.getMonth() + "-" + today.getDate();    
            var dateStr = today.toDateString();    
			d3.select("#date")
                .text(dateStr);
            var appl_json;
			var pf_json;
            d3.json(applDataUrl, function(json) {
				appl_json = json;
				//console.log(appl_json); //Log output to console
                
                /* 
                 * Nest d3.json call to be sure all data is loaded before drawing all panels
                 */
				// preparation for both data sets
				var pfDataUrl ="getCouchDbData.php?db=projects&design=process_flow&view=KPI&group_level=3&" + dbSource;
				//console.log("About to call d3.json again");
				d3.json(pfDataUrl, function(json) {
					pf_json = json;
					//console.log(pf_json); //Log output to console
					drawProcessPanels(appl_json, pf_json, today, twelveWeeks, panelHeights, drawWidth);
				});
				
			});
            // Problem KPIs. Not shown at the moment
            //var failedProgUrl = "getCouchDbData.php?db=projects&design=kpi_external&view=KPI1&reduce=false&" + dbSource;
            //d3.json(failedProgUrl, function(json){
            //    //console.log(json);
            //    var fpDataset = generateFailedProgressedDataset(json, today);
            //    //console.log(fpDataset);
            //    //drawBarchartPlot(fpDataset, "fs_prog_bc", 500, panelHeights, 30);
            //    drawBarchartPlot(fpDataset, "fs_prog_bc", (rcWidth + 110), panelHeights, 30);
            //});
            //
            //var wsFailRateUrl = "getCouchDbData.php?db=projects&design=kpi_external&view=KPI2&reduce=false&" + dbSource;
            //d3.json(wsFailRateUrl, function(json){
            //    //console.log("Workset failrate dataset:");
            //    //console.log(json);
            //    var d = generateWorksetFailureDataset (json, twelveWeeks, today);
            //    //console.log(d);
            //    drawFailedLpRunChart(d, "fs_ws_rc", [], rcWidth, panelHeights, 30);
            //    var bd = generateGenericBoxDataset(d, 1);
            //    //console.log(bd);
            //    drawBoxPlot(bd, "fs_ws_bp", panelHeights);
            //});
            //
            //var delDataUrl = "getCouchDbData.php?db=projects&design=kpi_external&view=KPI3_1&reduce=false&" + dbSource;
            //d3.json(delDataUrl, function(json){
            //    var delDataDataset = generateDeliveredDataDataset (json, twelveWeeks, today);
            //    //console.log("Data del dataset");
            //    //console.log(delDataDataset);
            //    drawDeliveredDataRunChart(delDataDataset, "data_del_rc", [], rcWidth, panelHeights, 30);
            //    var bd = generateGenericBoxDataset(delDataDataset, 1);
            //    drawBoxPlot(bd, "data_del_bp", panelHeights);
            //});
			
			/** Load stacks */
			var queueLaneLoadUrl = "getCouchDbData.php?db=projects&design=process_flow&view=KPI_appl_pf_dates_sampl_lanes&reduce=false&" + dbSource;
			d3.json(queueLaneLoadUrl, function(json){
                console.log("Drawing load stacks")
                //console.log(json);

                var reduced = reduceToProject(json);
                //console.log(reduced);
                var numLanes = calculateLanesStarted (json, twelveWeeks, today);
                var numPreps = calculateWorksetsStarted (json, twelveWeeks, today);
                //console.log(numLanes);
                //console.log(numPreps);
                
                d3.select("#lane_starts").text(parseFloat(numLanes.HiSeq/12).toFixed(1) + " / " + parseFloat(numLanes.MiSeq/12).toFixed(1)
                                               + " (" + parseFloat(numLanes.HiSeqSamples/12).toFixed(1) + "/" + parseFloat(numLanes.MiSeqSamples/12).toFixed(1) + " samples)");
                d3.select("#prep_starts").text(parseFloat(numPreps.DNA /12).toFixed(2) + " / " + parseFloat(numLanes.RNA/12).toFixed(2)
                                               + " / " + parseFloat(numPreps.SeqCap/12).toFixed(2) + " / " + parseFloat(numPreps.Other/12).toFixed(2));

				var recCtrl = generateRecCtrlStackDataset(json, today);
				var sampleQueue = generateQueueSampleStackDataset(json, today);
				var libprepLaneQueue = generateQueueLaneLPStackDataset(json, today);
				var finlibLaneQueue = generateQueueLaneFLStackDataset(json, today);
                var sampleLoadLibprep = generateLibprepSampleLoadDataset(json, today);
                var laneLoadLibprep = generateLibprepLaneLoadDataset(json, today);
                var seqLoad = generateSeqLoadDataset(json, today);
                
                //console.log(sampleLoadLibprep);
                
				/** 3 bar panels on the upper half.
				 *  
				 */ 
				var bar_width = (drawWidth + 320) / 17; // 17 bars to draw over the width of the window 				

				drawRCStackedBars(recCtrl, "ongoing_bc_plot", bar_width * 1, panelHeights);
                drawStackedBars (sampleQueue, "queue_sample_load_lp", bar_width * 4, panelHeights, "samples");
				drawStackedBars (libprepLaneQueue, "queue_lane_load_lp", bar_width * 2, panelHeights, "lanes");
				drawStackedBars (finlibLaneQueue, "queue_lane_load_fl", bar_width * 2, panelHeights, "lanes");
                drawStackedBars(sampleLoadLibprep, "libprep_sample_load", bar_width * 4, panelHeights, "samples");
                drawStackedBars(laneLoadLibprep, "libprep_lane_load", bar_width * 2, panelHeights, "lanes");
                drawStackedBars (seqLoad, "seq_load_stack", bar_width * 2, panelHeights, "lanes");
			});
            
            /**
             * Code for cycling between showing status kpis and problem kpis
             * Not used at the moment
             */
            //window.setInterval(function() {
            //    //console.log("in cycling function");
            //    problems_displayed = (d3.select("#problem_panels").attr("style") == "display: block");
            //    if(problems_displayed) {
            //        d3.select("#problem_panels").attr("style", "display: none");
            //        d3.select("#status_panels").attr("style", "display: block");
            //    } else {
            //        d3.select("#status_panels").attr("style", "display: none");
            //        d3.select("#problem_panels").attr("style", "display: block");
            //        
            //    }
            //}, 120000);

 
		</script>


	</body>
</html>